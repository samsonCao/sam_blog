### 基础知识

- 高优先级任务
  - 渲染
  - 布局
  - 绘制
  - 资源加载
  - 事件响应
- requestAnimationFrame
请求动画帧 每秒执行60次，每16.6ms执行一次

- requestIdleCallback
请求空闲回调
如果一个rAF的时间小于16.6ms，比如是10ms，那就会把剩余的6.6ms交给requestIdleCallback，执行自己想干的事情
如果 callback 执行时间超过16.6ms,那执行到16.6ms之后剩下的就暂停，把时间交给浏览器执行浏览器自己的事件
```javascript
// 告诉浏览器，我再执行callback,但是优先级比较低，告诉浏览器空间的时候执行callback
// 但是如果到了超时时间1000ms，就必须马上执行，不要再等空闲时间了
window.requestIdleCallback(callback, {timeout: 1000})
```

- MessageChannel

- 链表 [查看6.1.链表demo.js]('./6.1.链表demo.js')

- Fiber之前的历史
  - 更新虚拟dom的过程叫 reconciliation (协调)reconciliation 不可中断
  - Fiber之前更新dom,深度遍历递归遍历，中间不可中断，超过16.6ms没办法去执行其它浏览器事件，所以会卡顿

- Fiber是什么
  - 通过某些调度策略让 reconciliation 可中断，适时让出CUP执行权，可以让浏览器及时响应用户交互
  - Fiber是一个执行单元，每次执行完一个执行单元，react会检查还剩下多少时间，如果有没有剩余时间，就将控制权让出去
  - fiber是一个执行单元 [示意图](../Image/fiberWorkUnit.png)
  - fiber是一个数据结构 链表，每个节点有三个指针
  ```typescript
  // 每个Fiber节点有三个指针
  type Fiber = {
    child: Node, // 指向第一个儿子
    sibling: Node, // 指向下一个弟弟
    return: Node // 指向父亲
  }
  ```

- Fiber 执行阶段
  - 协调阶段 Reconciliation（协调/render阶段），可以认为是diff阶段，可以被中断。这个阶段会找出所有节点变更，例如节点新增、删除、属性变更，这些变更react称之为副作用
  - 提交阶段 Commit，将上一个阶段计算出来的需要处理的副作用Effects一次性执行了，这个阶段是同步的，不可被打断

- Fiber执行顺序（深度优先编辑）
  - 先找child
  - 没有child再找sibling
  - 兄弟也没有再返回父节点，再找父节点的兄弟
- Fiber深度优先的一种实现思路
```javascript
function beginWork(fiber) {
  console.log('开始',fiber.key)
}
function completeUnitWork(fiber) {
  console.log('结束',fiber.key)
}

let nextUnitOfWork = null;
function workLoop() {
  while(nextUnitOfWork) {
    nextUnitOfWork = performanceUnitOfWork(nextUnitOfWork);
  }
  if (!nextUnitOfWork) {
    console.log('render阶段结束了')
  }
}
function performanceUnitOfWork(fiber) {
  // 处理此fiber
  beginWork(fiber);
  // 有儿子先返回儿子执行workLoop的while循环
  if (fiber.child) {
    return fiber.child
  }
  // 没有儿子说明此fiber结束了
  while(fiber) {
    completeUnitWork(fiber);
  // 有兄弟先返回兄弟节点，执行workLoop的while循环
    if (fiber.sibling) {
      return fiber.sibling;
    }
    // 没有兄弟节点，fiber指向父节点，找父节点的兄弟节点，直到找到父节点兄弟节点返回
    fiber = fiber.return;
  }
}

nextUnitOfWork = someRootFiber
workLoop();
```